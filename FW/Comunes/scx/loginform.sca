SCCTEXT Version 4.0.0.2
PLATFORM C(8,0),UNIQUEID C(10,0),TIMESTAMP N(10,0),CLASS M(4,0),CLASSLOC M(4,0),BASECLASS M(4,0),OBJNAME M(4,0),PARENT M(4,0),PROPERTIES M(4,0),PROTECTED M(4,0),METHODS M(4,0),OBJCODE M(4,0),OLE M(4,0),OLE2 M(4,0),RESERVED1 M(4,0),RESERVED2 M(4,0),RESERVED3 M(4,0),RESERVED4 M(4,0),RESERVED5 M(4,0),RESERVED6 M(4,0),RESERVED7 M(4,0),RESERVED8 M(4,0),USER M(4,0)
1252

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] Screen    
[START RESERVED1]
VERSION =   3.00[END RESERVED1]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QC75Y
[CLASS] dataenvironment
[BASECLASS] dataenvironment
[OBJNAME] Dataenvironment
[START PROPERTIES]
Top = 220
Left = 1
Width = 520
Height = 200
DataSource = .NULL.
Name = "Dataenvironment"
[END PROPERTIES]
[START RESERVED2]
1[END RESERVED2]
[START RESERVED4]
2[END RESERVED4]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QC75Z
[CLASS] form
[BASECLASS] form
[OBJNAME] FRMLOGIN
[START PROPERTIES]
DataSession = 2
BorderStyle = 2
Height = 90
Width = 272
ShowWindow = 1
DoCreate = .T.
ShowTips = .T.
AutoCenter = .T.
Caption = "Ingreso de usuario"
MaxButton = .F.
MinButton = .F.
WindowType = 1
_memberdata =      696<VFPData><memberdata name="aceptar" type="method" display="Aceptar"/><memberdata name="cancelar" type="method" display="Cancelar"/><memberdata name="validar" type="method" display="Validar"/><memberdata name="lreturn" type="property" display="lReturn"/><memberdata name="nintentosfallidos" type="property" display="nIntentosFallidos"/><memberdata name="nmaxintentos" type="property" display="nMaxIntentos"/><memberdata name="nreturn" type="property" display="nReturn" favorites="True"/><memberdata name="oreturn" display="oReturn"/><memberdata name="crootworkfolder" display="cRootWorkFolder"/><memberdata name="csetcursor" display="cSetCursor"/><memberdata name="obiz" display="oBiz"/></VFPData>
lreturn = .F.
nintentosfallidos = 0
nmaxintentos = 3
nreturn = -1
oreturn = .NULL.
crootworkfolder = 
csetcursor = 
obiz = .NULL.
Name = "FRMLOGIN"
[END PROPERTIES]
[START METHODS]
PROCEDURE Destroy
Local lcCommand As String,;
	lcSetCursor As String

Try

	lcCommand = ""
	Set Sysmenu Automatic
	lcSetCursor = Thisform.cSetCursor
	Set Cursor &lcSetCursor

Catch To oErr
	Local loError As ErrorHandler Of "Tools\ErrorHandler\Prg\ErrorHandler.prg"
	loError = Newobject( "ErrorHandler", "ErrorhandlerPrg\ErrorHandler.prg" )
	loError.Cremark = lcCommand
	loError.Process( oErr )


Finally


Endtry


ENDPROC
PROCEDURE Init
#INCLUDE "FW\Comunes\Include\Praxis.h"

Lparameters oBiz As Object

Local llOk As Boolean
Local lcCommand As String
Local loUser As User Of "Fw\TierAdapter\Comun\prxUser.prg"


Try
	llOk = .F.
	
	Thisform.oBiz = oBiz

	lcCommand = ""
	Thisform.cSetCursor = Set("Cursor")
	Set Cursor On

	If .T. && IsRuntime()
		If Vartype( DRVA ) # "C"
			If  FileExist( Addbs( lcRootWorkFolder ) + "SUCURSAL.DBF")

				Use Addbs( lcRootWorkFolder ) + "SUCURSAL"

				Loca For ACTIVO

				If !Eof()
					lcParameFileName = Addbs( Alltrim( RUTA )) + "arParame"
				Endif

			Endif

			TEXT To lcCommand NoShow TextMerge Pretext 15
			Restore From '<<lcParameFileName>>' Additive
			ENDTEXT

			&lcCommand

		Endif

		If Vartype( DRCOMUN ) = "C"
			lcRootWorkFolder = DRCOMUN

		Else
			lcRootWorkFolder = DRVA

		Endif

	Else
		lcRootWorkFolder = "fw\comunes\Dbf\"


	Endif

	This.cRootWorkFolder = lcRootWorkFolder
	
	M_Use( 0, lcRootWorkFolder + 'Usuarios' )
	
	If Type( "Usuarios.Permiso" ) # "N"
		Use in Select( "Usuarios" )
		
		Text To lcCommand NoShow TextMerge Pretext 15
		Use '<<lcRootWorkFolder>>Usuarios.Dbf' In 0 Exclusive
		EndText

		&lcCommand
	
		
		Alter Table Usuarios Add Column Permiso I
		
		Update Usuarios Set Permiso = Nivel
		
		Use in Select( "Usuarios" )

		M_Use( 0, lcRootWorkFolder + 'Usuarios' )
		
	EndIf
	

	If Type( "Usuarios.GroupId" ) # "N"
		Use in Select( "Usuarios" )
		
		Text To lcCommand NoShow TextMerge Pretext 15
		Use '<<lcRootWorkFolder>>Usuarios.Dbf' In 0 Exclusive
		EndText

		&lcCommand
	
		
		Alter Table Usuarios Add Column GroupId I
		
		Update Usuarios Set GroupId = Iif( Nivel = 5, GRP_ADMIN, GRP_USUARIO )
		
		Use in Select( "Usuarios" )

		M_Use( 0, lcRootWorkFolder + 'Usuarios' )
		
	EndIf


	* Verificar que existe el campo Id
	If Type( "Usuarios.Id" ) # "N"
		Use in Select( "Usuarios" )
		
		Text To lcCommand NoShow TextMerge Pretext 15
		Use '<<lcRootWorkFolder>>Usuarios.Dbf' In 0 Exclusive
		EndText

		&lcCommand
			
		Alter Table Usuarios Add Column Id I
		
		Update Usuarios Set Id = Recno()
		
		Use in Select( "Usuarios" )

		M_Use( 0, lcRootWorkFolder + 'Usuarios' )
		
	EndIf

	Try
	
		Set Order To usuario In usuarios		
	
	Catch To oErr
		If oErr.ErrorNo = 26 && Table has no index order set
			Use in Select( "Usuarios" )
			M_Use( 0, lcRootWorkFolder + 'Usuarios', 0, .T. )
			Index On usuario+clave tag Usuario For Not Deleted() CANDIDATE
			
			Use in Select( "Usuarios" )
			M_Use( 0, lcRootWorkFolder + 'Usuarios' )
			Set Order To usuario In usuarios		

		Else
			Local loError as Errorhandler OF "Tools\ErrorHandler\Prg\ErrorHandler.prg"
			loError = NewObject( "Errorhandler", "ErrorhandlerPrg\ErrorHandler.prg" )
			loError.Process( oErr )
			Throw loError

		Endif

	Finally

	EndTry

	
	llOk = .T.

	loUser = Newobject( "User", "Fw\TierAdapter\Comun\prxUser.prg" )
	
	AddProperty( loUser, "Cancela", .F. )
	
	This.oReturn = loUser

	Set Sysmenu Off
	
Catch To oErr
	llOk = .F.
	loError = Newobject( "ErrorHandler", "ErrorhandlerPrg\ErrorHandler.prg" )
	loError.Cremark = lcCommand
	loError.Process( oErr )
	Throw loError

Finally

Endtry

Return llOk

ENDPROCPROCEDURE Load
Set TablePrompt Off
ENDPROC
PROCEDURE Unload
* DAE 2009-11-27(13:38:52)

Use In Select( 'usuarios' )

Return This.oReturn

ENDPROC
PROCEDURE aceptar
* DAE 2009-11-27(13:13:33)
Local loError As ErrorHandler Of "Tools\ErrorHandler\Prg\ErrorHandler.prg"
Try
	If This.Validar( This.txtUsuario.Value, This.txtPass.Value )
		This.Release()

	Else
		Warning( 'Usuario o contraseña invalido' )
		This.nIntentosFallidos = This.nIntentosFallidos + 1

		If This.nIntentosFallidos < This.nMaxIntentos
			This.txtUsuario.SetFocus()

		Else
			This.Release()

		Endif && This.nIntentosFallidos < This.nMaxIntentos

	Endif && This.Validar( This.txtUsuario.Value, This.txtPass.Value )

Catch To oErr
	loError = Newobject( "ErrorHandler", "ErrorhandlerPrg\ErrorHandler.prg" )
	loError.Process( oErr )
	Throw loError

Finally
	loError = Null

Endtry

ENDPROC
PROCEDURE cancelar
* DAE 2009-11-27(13:38:48)

Thisform.oReturn.Cancela = .T.

This.Release()

ENDPROC
PROCEDURE validar
Lparameters tcUsuario As String, tcPass As String
* DAE 2009-11-27(13:38:40)

Local loError As ErrorHandler Of "Tools\ErrorHandler\Prg\ErrorHandler.prg"
Local loBlowFish As BlowFish Of  fw\comunes\prg\BlowFish.prg
Local lcCode As String
Local llOk As Boolean

Try
    * This.oReturn = Null
    llOk = .F.
    tcUsuario = Upper( Alltrim( tcUsuario ) )
    tcPass = Upper( Alltrim( tcPass ))

    If Indexseek( tcUsuario, .T., 'usuarios' )
        loBlowFish = Newobject( 'BlowFish', 'fw\comunes\prg\blowfish.prg' )
        lcCode = loBlowFish.CodificarSimple(tcUsuario + tcPass, 'PraxisComputación' )
        llOk = ( lcCode == Alltrim( Usuarios.Clave ) )

        If llOk
            With This.oReturn
            	.Id			= Usuarios.Id
                .Usuario 	= tcUsuario
                .Nivel 		= Usuarios.Nivel
                .Permiso 	= Usuarios.Permiso
                .GroupId 	= Usuarios.GroupId
                .Nombre 	= Alltrim( Usuarios.Nombre )
                .IsAdmin 	= ( Usuarios.Nivel = 5 )
                .IsGuest 	= .F.
                .Password 	= Usuarios.Clave
                .lOk 		= .T.

				Try

					Text To lcCommand NoShow TextMerge Pretext 15
					Select Nombre
						From <<This.cRootWorkFolder>>Grupos g
						Where g.Id = Usuarios.GroupId
						Into Cursor cGrupo
					EndText

					&lcCommand
					
					If _Tally = 1
						.Grupo = cGrupo.Nombre
						
					Else
						.Grupo = ""
						
					Endif

				Catch To oErr
					.Grupo = ""
					
				Finally
					Use in Select( "cGrupo" )
					Use in Select( "Grupos" )

				EndTry
			

            Endwith

        Endif && llOk

    Endif && Indexseek( tcUsuario, .T., 'usuarios' )

Catch To oErr
    loError = Newobject( "ErrorHandler", "ErrorhandlerPrg\ErrorHandler.prg" )
    loError.Process( oErr )
    Throw loError

Finally
    loError = Null
    loBlowFish = Null

Endtry

Return llOk



ENDPROC
[END METHODS]
[START RESERVED3]
_memberdata XML Metadata for customizable properties
lreturn
nintentosfallidos
nmaxintentos
nreturn
oreturn
crootworkfolder Carpeta donde se encuentra la tabla Usuarios
csetcursor Valor del seteo del cursor al ser llamado
obiz Clase de negocios
*aceptar 
*cancelar 
*validar 
[END RESERVED3]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QC75Y
[CLASS] commandbutton
[BASECLASS] commandbutton
[OBJNAME] cmdAceptar
[PARENT] FRMLOGIN
[START PROPERTIES]
Top = 56
Left = 64
Height = 25
Width = 100
Picture = ..\image\bmp\manook.bmp
Caption = "\<Aceptar"
TabIndex = 5
SpecialEffect = 2
PicturePosition = 2
PictureMargin = 1
Name = "cmdAceptar"
[END PROPERTIES]
[START METHODS]
PROCEDURE Click
* DAE 2009-11-27(13:39:07)
Local loError As ErrorHandler Of "Tools\ErrorHandler\Prg\ErrorHandler.prg"
Try

	Thisform.Aceptar()

Catch To oErr
	loError = Newobject( "ErrorHandler", "Tools\ErrorHandler\Prg\ErrorHandler.prg" )
	loError.Process( oErr )

Finally
	loError = Null

Endtry

ENDPROC
[END METHODS]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QOB72
[CLASS] commandbutton
[BASECLASS] commandbutton
[OBJNAME] cmdCancelar
[PARENT] FRMLOGIN
[START PROPERTIES]
Top = 56
Left = 168
Height = 25
Width = 100
Picture = ..\image\bmp\manocancel.bmp
Cancel = .T.
Caption = "\<Cancelar"
TabIndex = 6
SpecialEffect = 2
PicturePosition = 2
PictureMargin = 1
Name = "cmdCancelar"
[END PROPERTIES]
[START METHODS]
PROCEDURE Click
* DAE 2009-11-27(13:39:13)
Local loError As ErrorHandler Of "Tools\ErrorHandler\Prg\ErrorHandler.prg"
Try

	Thisform.Cancelar()

Catch To oErr
	loError = Newobject( "ErrorHandler", "ErrorhandlerPrg\ErrorHandler.prg" )
	loError.Process( oErr )

Finally
	loError = Null

Endtry

ENDPROC
[END METHODS]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QC75Y
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] txtUsuario
[PARENT] FRMLOGIN
[START PROPERTIES]
Format = "!"
Height = 21
Left = 64
MaxLength = 32
StatusBarText = "Ingrese el usuario"
TabIndex = 2
ToolTipText = "Ingrese el usuario"
Top = 8
Width = 203
Name = "txtUsuario"
[END PROPERTIES]
[START METHODS]
PROCEDURE GotFocus
* DAE 2009-11-27(13:39:20)
This.BackColor = Rgb( 220,255,255 )
This.Parent.lblUsuario.FontUnderline = .T.

ENDPROC
PROCEDURE LostFocus
* DAE 2009-11-27(13:39:23)
This.BackColor = Rgb( 255, 255, 255)
This.Parent.lblUsuario.FontUnderline = .F.

ENDPROC
[END METHODS]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QOB73
[CLASS] textbox
[BASECLASS] textbox
[OBJNAME] txtPass
[PARENT] FRMLOGIN
[START PROPERTIES]
Height = 21
Left = 64
MaxLength = 32
StatusBarText = "Ingrese la clave"
TabIndex = 4
ToolTipText = "Ingrese la clave"
Top = 32
Width = 203
PasswordChar = "*"
Name = "txtPass"
[END PROPERTIES]
[START METHODS]
PROCEDURE GotFocus
* DAE 2009-11-27(13:39:31)
This.BackColor = RGB(220,255,255)
This.Parent.lblClave.FontUnderline = .T.
ENDPROC
PROCEDURE LostFocus
* DAE 2009-11-27(13:39:26)
This.BackColor = Rgb( 255, 255, 255 )
This.Parent.lblClave.FontUnderline = .F.

ENDPROC
[END METHODS]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QC75Y
[CLASS] label
[BASECLASS] label
[OBJNAME] lblUsuario
[PARENT] FRMLOGIN
[START PROPERTIES]
AutoSize = .F.
Caption = "Usuario:"
Height = 17
Left = 8
Top = 8
Width = 52
TabIndex = 1
ToolTipText = "Ingrese el usuario"
StatusBarText = "Ingrese el usuario"
Name = "lblUsuario"
[END PROPERTIES]
[START METHODS]
PROCEDURE Click
* DAE 2009-11-27(13:40:18)
This.Parent.txtUsuario.SetFocus()

ENDPROC
PROCEDURE MouseEnter
Lparameters nButton, nShift, nXCoord, nYCoord
* DAE 2009-11-27(13:39:45)
This.MousePointer= 15

ENDPROC
PROCEDURE MouseLeave
Lparameters nButton, nShift, nXCoord, nYCoord
* DAE 2009-11-27(13:39:50)
This.MousePointer = 0

ENDPROC
[END METHODS]

[ RECORD]
[PLATFORM] WINDOWS 
[UNIQUEID] _2SY0QOB74
[CLASS] label
[BASECLASS] label
[OBJNAME] lblClave
[PARENT] FRMLOGIN
[START PROPERTIES]
AutoSize = .F.
Caption = "Clave:"
Height = 17
Left = 8
Top = 32
Width = 52
TabIndex = 3
ToolTipText = "Ingrese la clave"
StatusBarText = "Ingrese la clave"
Name = "lblClave"
[END PROPERTIES]
[START METHODS]
PROCEDURE Click
* DAE 2009-11-27(13:40:03)
This.Parent.txtPass.SetFocus()

ENDPROC
PROCEDURE MouseEnter
Lparameters nButton, nShift, nXCoord, nYCoord
* DAE 2009-11-27(13:40:08)
This.MousePointer= 15

ENDPROC
PROCEDURE MouseLeave
Lparameters nButton, nShift, nXCoord, nYCoord
* DAE 2009-11-27(13:39:57)
This.MousePointer = 0

ENDPROC
[END METHODS]

[ RECORD]
[PLATFORM] COMMENT 
[UNIQUEID] RESERVED  
[START PROPERTIES]
Arial, 0, 9, 5, 15, 12, 32, 3, 0
[END PROPERTIES]
[START RESERVED1]
  ..\include\praxis.hBS ..\include\foxpro.hCÊrûF ..\include\strings.hDZOJ* ..\..\..\tools\namespaces\include\system.h&E±ÙF[END RESERVED1]
[EOF]
